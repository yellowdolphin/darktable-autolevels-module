# autolevels

Lua-скрипт для [darktable](https://www.darktable.org)

## Назва

autolevels.lua — автоматична корекція кольору за допомогою _Крива RGB_

## Опис

Цей скрипт викликає AutoLevels для додавання екземпляра _Крива RGB_ з базовою корекцією кольору.

[AutoLevels](https://github.com/yellowdolphin/autolevels) — це скрипт на Python для пакетної обробки зображень із фокусом на відсканованих аналогових фотографіях із вицвілими кольорами. Він використовує модель машинного навчання (ML) для автоматичного відновлення вицвілих кольорів та контрасту, прийнятного для відображення (вихідні колірні простори sRGB або Adobe RGB). Ця модель передбачає криві для трьох колірних каналів, які використовуються як сплайни в модулі _Крива RGB_ darktable.

Цей скрипт автоматизує базову корекцію кольору за допомогою RGB-кривих. Він не додає жодної колірної градації чи «вигляду» до зображення. Ви можете вручну налаштувати криві за потреби. Будь-яке подальше художнє редагування слід виконувати в окремому екземплярі _Крива RGB_.

## Встановлення

Завантажте [autolevels.zip](https://github.com/yellowdolphin/darktable-autolevels-module/releases/download/nightly/autolevels-nightly.zip) та розпакуйте його в підпапку lua у вашому каталозі конфігурації darktable (наприклад, `~/.config/darktable/lua/contrib/` в Linux або `%AppData%\darktable\lua\contrib\` в Windows).

## Використання

* Запустіть цей скрипт у модулі _Сценарії_ у режимі Світлий стіл. У тій самій панелі з'явиться модуль _AutoLevels_.

* Запустіть цей скрипт у модулі _Сценарії_ у режимі Світлий стіл. У тій самій панелі з'явиться модуль _AutoLevels_.

* Завантажте ONNX-модель кривих [тут](https://github.com/yellowdolphin/darktable-autolevels-module/releases/download/v1.0.0rc/free_xcittiny_wa14.onnx) або з [веб-сайту RetroShine](https://retroshine.eu/download/free_xcittiny_wa14.onnx)

* Натисніть маленьку кнопку файлового браузера, щоб знайти завантажений файл .onnx

* Виберіть зображення та натисніть кнопку "додати криву AutoLevels"

* Ви можете прискорити обробку (до 2x), збільшивши *розмір пакета* у модулі _AutoLevels_. Це оновлюватиме прогрес і дозволить зупинку лише після завершення кожного пакета.

* У режимі Темна кімната ви знайдете новий елемент історії, який додає екземпляр _Крива RGB_ у режимі "RGB, незалежні канали". Ви можете вносити зміни до кривих, оригінальні криві залишатимуться в _Iсторія_ до тих пір, поки ви не стиснете Історію змін.

Ви можете помітити, що екземпляр _Крива RGB_, створений AutoLevels, застосовується безпосередньо перед модулем _Вхідний колірний профіль_. Це місце, де поканальна корекція кольору працює найефективніше для JPEG та більшості HDR-зображень (формати RAW поки не підтримуються скриптом). Якщо ви створите новий екземпляр _Крива RGB_, він з'явиться у звичайному місці в конвеєрі обробки.

### Що він робить

Під капотом Lua-скрипт викликає `autolevels` з аргументом `--export darktable <версія>`:

```
autolevels --model ~/Downloads/free_xcittiny_wa14.onnx --export darktable 5.3.0 --outsuffix .jpg.xmp -- myimage.jpg
```

AutoLevels зчитує файл XMP-супроводу, пов'язаний із кожним вибраним зображенням (або дублікатом). Він передається через опцію `--outsuffix`. Якщо файл XMP не існує, AutoLevels створить мінімальний файл із стандартними автоматично застосованими налаштуваннями. Опція `--outsuffix` є необов'язковою і запобігає створенню AutoLevels вихідного зображення, якщо її значення закінчується на ".xmp".

Якщо ви хочете викликати AutoLevels з опцією `--export darktable` поза darktable, зверніть увагу, що darktable зчитує XMP-файли при запуску лише якщо ви активували опцію `шукати оновлені XMP-файли при запуску` у налаштуваннях/Збереження даних.

## Додаткове програмне забезпечення

- Python 3.9 або новіший

- AutoLevels

У більшості дистрибутивів Linux Python уже попередньо встановлений. Для інших операційних систем завантажте його з [Python.org](https://www.python.org/downloads/) або встановіть через ваш улюблений магазин додатків. Переконайтеся, що ви відмітили прапорець "Add Python executable to PATH". Потім, щоб встановити AutoLevels, відкрийте термінал (cmd у Windows) і виконайте:

```bash
pip install autolevels
```

Це автоматично встановить AutoLevels та наступні залежності:

- numpy
- pillow
- piexif
- opencv-python
- h5py
- onnxruntime

## Обмеження

RAW-зображення наразі не підтримуються.

## Автор

Marius Wanko - marius.wanko@outlook.de

## Журнал змін